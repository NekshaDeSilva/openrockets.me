<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Test - OpenRockets</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            color: #333;
            margin-top: 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
        #chatMessages {
            height: 300px;
            border: 1px solid #ddd;
            padding: 10px;
            overflow-y: auto;
            background: #f9f9f9;
            margin: 10px 0;
        }
        input[type="text"] {
            width: 70%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .message {
            margin: 5px 0;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üöÄ OpenRockets Community System Test</h1>
        <p>This page tests all the community features to identify what's working and what needs to be fixed.</p>

        <!-- Connection Status -->
        <div class="test-section">
            <h3>üì° Connection Status</h3>
            <div id="connectionStatus" class="status info">Checking connection...</div>
            <button onclick="testConnection()">Test API Connection</button>
            <button onclick="testSocket()">Test WebSocket</button>
        </div>

        <!-- Posts System -->
        <div class="test-section">
            <h3>üìù Posts System</h3>
            <div id="postsStatus" class="status info">Testing posts...</div>
            <button onclick="loadPosts()">Load Posts</button>
            <button onclick="createTestPost()">Create Test Post</button>
            <button onclick="likePost()">Test Like System</button>
            <div id="postsContainer"></div>
        </div>

        <!-- Chat System -->
        <div class="test-section">
            <h3>üí¨ Live Chat System</h3>
            <div id="chatStatus" class="status info">Chat disconnected</div>
            <div id="chatMessages"></div>
            <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="handleChatEnter(event)">
            <button onclick="sendTestMessage()">Send Message</button>
        </div>

        <!-- User System -->
        <div class="test-section">
            <h3>üë§ User System</h3>
            <div id="userStatus" class="status info">Checking user status...</div>
            <button onclick="testAuth()">Test Authentication</button>
            <button onclick="loadActiveUsers()">Load Active Users</button>
            <div id="usersContainer"></div>
        </div>

        <!-- File Upload -->
        <div class="test-section">
            <h3>üì∏ File Upload System</h3>
            <div id="uploadStatus" class="status info">Upload system ready</div>
            <input type="file" id="testFile" accept="image/*">
            <button onclick="testUpload()">Test Upload</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js"></script>
    <script>
        let socket = null;
        let isConnected = false;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            testConnection();
            testSocket();
            testAuth();
        });

        // Test API Connection
        async function testConnection() {
            const statusEl = document.getElementById('connectionStatus');
            try {
                const response = await fetch('http://localhost:3000/api/community/posts');
                if (response.ok) {
                    statusEl.className = 'status success';
                    statusEl.textContent = '‚úÖ API Connection successful!';
                    loadPosts();
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `‚ùå API Connection failed: ${error.message}`;
            }
        }

        // Test WebSocket Connection
        function testSocket() {
            const statusEl = document.getElementById('chatStatus');
            try {
                socket = io('http://localhost:3000');
                
                socket.on('connect', () => {
                    isConnected = true;
                    statusEl.className = 'status success';
                    statusEl.textContent = '‚úÖ WebSocket connected!';
                    
                    // Join as test user
                    socket.emit('join-user', { 
                        userId: 'test-user', 
                        username: 'Test User' 
                    });
                });

                socket.on('disconnect', () => {
                    isConnected = false;
                    statusEl.className = 'status error';
                    statusEl.textContent = '‚ùå WebSocket disconnected';
                });

                socket.on('new-message', (data) => {
                    displayMessage(data);
                });

                socket.on('user-joined', (data) => {
                    addSystemMessage(`${data.username} joined the chat`);
                });

            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `‚ùå WebSocket failed: ${error.message}`;
            }
        }

        // Load Posts
        async function loadPosts() {
            const statusEl = document.getElementById('postsStatus');
            const container = document.getElementById('postsContainer');
            
            try {
                const response = await fetch('http://localhost:3000/api/community/posts');
                const data = await response.json();
                
                statusEl.className = 'status success';
                statusEl.textContent = `‚úÖ Loaded ${data.posts.length} posts`;
                
                container.innerHTML = data.posts.map(post => `
                    <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px;">
                        <h4>${post.title || 'No title'}</h4>
                        <p>${post.content.substring(0, 100)}...</p>
                        <small>By: ${post.author.fullName} | Likes: ${post.likes}</small>
                        <br>
                        <button onclick="likePost('${post.id}')">üëç Like</button>
                        <button onclick="viewComments('${post.id}')">üí¨ Comments</button>
                    </div>
                `).join('');
                
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `‚ùå Failed to load posts: ${error.message}`;
            }
        }

        // Create Test Post
        async function createTestPost() {
            const statusEl = document.getElementById('postsStatus');
            
            try {
                const postData = {
                    title: 'Test Post from Test Page',
                    content: 'This is a test post created from the community test page to verify the posting system is working correctly.',
                    category: 'testing',
                    tags: ['test', 'community', 'debug'],
                    author: {
                        fullName: 'Test User',
                        profileImage: null
                    }
                };

                const formData = new FormData();
                formData.append('data', JSON.stringify(postData));

                const response = await fetch('http://localhost:3000/api/community/posts', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    statusEl.className = 'status success';
                    statusEl.textContent = '‚úÖ Test post created successfully!';
                    loadPosts(); // Refresh posts
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `‚ùå Failed to create post: ${error.message}`;
            }
        }

        // Like Post
        async function likePost(postId = '1') {
            try {
                const response = await fetch(`http://localhost:3000/api/community/posts/${postId}/like`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('postsStatus').textContent = `‚úÖ Liked post! Total likes: ${result.likes}`;
                    loadPosts(); // Refresh to see updated likes
                }
                
            } catch (error) {
                document.getElementById('postsStatus').textContent = `‚ùå Like failed: ${error.message}`;
            }
        }

        // View Comments
        async function viewComments(postId) {
            try {
                const response = await fetch(`http://localhost:3000/api/community/posts/${postId}/comments`);
                const data = await response.json();
                alert(`Comments for post ${postId}: ${data.comments.length} comments`);
            } catch (error) {
                alert(`Failed to load comments: ${error.message}`);
            }
        }

        // Send Test Message
        function sendTestMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!isConnected) {
                alert('WebSocket not connected!');
                return;
            }
            
            if (message) {
                socket.emit('send-message', {
                    message: message,
                    channel: 'general'
                });
                input.value = '';
            }
        }

        // Handle Enter key for chat
        function handleChatEnter(event) {
            if (event.key === 'Enter') {
                sendTestMessage();
            }
        }

        // Display message in chat
        function displayMessage(data) {
            const container = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message';
            messageEl.innerHTML = `
                <strong>${data.username}:</strong> ${data.message}
                <br><small>${new Date(data.timestamp).toLocaleTimeString()}</small>
            `;
            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
        }

        // Add system message
        function addSystemMessage(text) {
            const container = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message';
            messageEl.innerHTML = `<em>ü§ñ ${text}</em>`;
            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
        }

        // Test Authentication
        async function testAuth() {
            const statusEl = document.getElementById('userStatus');
            // For now, just simulate guest user
            statusEl.className = 'status info';
            statusEl.textContent = 'üë§ Running as Guest User (authentication not required for testing)';
        }

        // Load Active Users
        function loadActiveUsers() {
            const container = document.getElementById('usersContainer');
            // Simulate active users
            container.innerHTML = `
                <div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                    <h4>Active Users</h4>
                    <p>‚Ä¢ Test User (You)</p>
                    <p>‚Ä¢ Dr. Sarah Chen (Online)</p>
                    <p>‚Ä¢ Mike Johnson (Coding)</p>
                    <p>‚Ä¢ Alice Smith (Available)</p>
                </div>
            `;
        }

        // Test File Upload
        async function testUpload() {
            const statusEl = document.getElementById('uploadStatus');
            const fileInput = document.getElementById('testFile');
            const file = fileInput.files[0];
            
            if (!file) {
                statusEl.className = 'status error';
                statusEl.textContent = '‚ùå Please select a file first';
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('images', file);
                
                const testData = {
                    title: 'Image Upload Test',
                    content: 'Testing image upload functionality',
                    category: 'testing'
                };
                formData.append('data', JSON.stringify(testData));
                
                statusEl.className = 'status info';
                statusEl.textContent = '‚è≥ Uploading file...';
                
                const response = await fetch('http://localhost:3000/api/community/posts', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusEl.className = 'status success';
                    statusEl.textContent = '‚úÖ File uploaded successfully!';
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `‚ùå Upload failed: ${error.message}`;
            }
        }
    </script>
</body>
</html>
